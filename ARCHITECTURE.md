# Архитектура проекта

## Общая структура

```
┌─────────────────────────────────────────────────────────────┐
│                         MAIN.RS                              │
│                  (Bevy App + Game Loop)                      │
└──────────────┬──────────────────────────────────────────────┘
               │
    ┌──────────┴──────────┬──────────────┬──────────────┐
    │                     │              │              │
┌───▼────┐         ┌─────▼─────┐  ┌─────▼─────┐  ┌────▼─────┐
│SYSTEMS │         │COMPONENTS │  │ GENETICS  │  │  BATTLE  │
│        │◄────────┤           │  │           │  │          │
└───┬────┘         └───────────┘  └─────┬─────┘  └────┬─────┘
    │                                   │              │
    │              ┌────────────────────┘              │
    │              │                                   │
┌───▼──────┐  ┌───▼───┐  ┌──────┐  ┌────────┐  ┌────▼─────┐
│  CAMERA  │  │   AI  │  │  MAP │  │   UI   │  │ EVOLUTION│
└──────────┘  └───────┘  └──────┘  └────────┘  └──────────┘
```

## Поток данных

```
START
  │
  ├─► Setup()
  │    ├─► Создание камеры
  │    ├─► Генерация карты (map.rs)
  │    ├─► Инициализация популяции (genetics.rs)
  │    └─► Создание танков (battle.rs)
  │
  ├─► GameState::Battle
  │    │
  │    ├─► Systems (каждый кадр)
  │    │    ├─► tank_movement_system
  │    │    ├─► ai_control_system
  │    │    │    └─► Нейронная сеть (ai.rs)
  │    │    ├─► projectile_movement_system
  │    │    ├─► collision_system
  │    │    └─► camera_control_system
  │    │
  │    └─► check_battle_end
  │         └─► Если бой окончен → GameState::Evolution
  │
  ├─► GameState::Evolution
  │    ├─► Сортировка по фитнесу
  │    ├─► Селекция (лучшие 20%)
  │    ├─► Скрещивание (crossover)
  │    ├─► Мутация
  │    ├─► Сохранение лучших
  │    └─► Переход обратно в Setup
  │
  └─► REPEAT
```

## ECS Архитектура (Entity-Component-System)

### Entities (Сущности)
- Tank (танк)
- Projectile (снаряд)
- Camera (камера)
- Map Objects (объекты карты)

### Components (Компоненты)
```rust
Tank {
    health: f32,
    max_health: f32,
    speed: f32,
    rotation_speed: f32,
    generation: u32,
    team: u32,
}

AIController {
    genome: Vec<f32>,      // 96 весов нейросети
    fitness: f32,          // Оценка успешности
    kills: u32,            // Убийств
    survival_time: f32,    // Время жизни
}

Projectile {
    damage: f32,
    speed: f32,
    lifetime: Timer,
    owner: Entity,
}
```

### Systems (Системы)
Обрабатывают entities с определенными компонентами:

```rust
// Система ИИ: обрабатывает (Tank + AIController)
ai_control_system(
    Query<(Entity, Transform, Tank, AIController)>
)

// Система столкновений: обрабатывает (Projectile) и (Tank)
collision_system(
    Query<(Entity, Transform, Projectile)>,
    Query<(Entity, Transform, Tank)>
)
```

## Нейронная сеть

```
Входы (8)          Скрытые (8)        Выходы (4)
    
[Здоровье]            [N1]            [Движение]
[Дистанция]           [N2]            [Поворот]
[Направление X]   →   [N3]        →   [Стрельба]
[Направление Z]       [N4]            [Резерв]
[Угол sin]            [N5]
[Угол cos]            [N6]
[Здоровье врага]      [N7]
[Свой угол]           [N8]

Всего весов: 8×8 + 8×4 = 96 параметров
```

## Генетический алгоритм

```
┌────────────────────────────────────────────────┐
│  ПОКОЛЕНИЕ N (20 танков)                       │
│  Геномы: [w1, w2, ... w96] × 20                │
└─────────────────┬──────────────────────────────┘
                  │
                  ▼
         ┌────────────────┐
         │   БОЙ (120 сек) │
         └────────┬───────┘
                  │
                  ▼
         ┌────────────────┐
         │   ОЦЕНКА       │
         │ fitness = f(k,t)│
         └────────┬───────┘
                  │
                  ▼
         ┌────────────────┐
         │   СОРТИРОВКА   │
         │  по fitness    │
         └────────┬───────┘
                  │
         ┌────────┴────────┐
         │                 │
    ┌────▼────┐      ┌────▼─────┐
    │ ЭЛИТА   │      │ ТУРНИР   │
    │ (20%)   │      │ СЕЛЕКЦИЯ │
    └────┬────┘      └────┬─────┘
         │                │
         └────────┬───────┘
                  │
                  ▼
         ┌────────────────┐
         │  СКРЕЩИВАНИЕ   │
         │  (crossover)   │
         └────────┬───────┘
                  │
                  ▼
         ┌────────────────┐
         │    МУТАЦИЯ     │
         │   (10% генов)  │
         └────────┬───────┘
                  │
                  ▼
┌─────────────────────────────────────────────────┐
│  ПОКОЛЕНИЕ N+1 (20 танков)                      │
│  Новые геномы                                   │
└─────────────────────────────────────────────────┘
```

## Структура файлов

```
smart_bot/
├── Cargo.toml                 # Зависимости
├── README.md                  # Основная документация
├── QUICKSTART.md              # Быстрый старт
├── EXAMPLES.md                # Примеры использования
├── ARCHITECTURE.md            # Этот файл
├── .gitignore
│
└── src/
    ├── main.rs                # Entry point, Bevy App
    ├── components.rs          # ECS компоненты
    │                           ├─ Tank
    │                           ├─ Projectile
    │                           ├─ AIController
    │                           └─ ...
    │
    ├── systems.rs             # Игровые системы
    │                           ├─ tank_movement_system
    │                           ├─ ai_control_system
    │                           ├─ collision_system
    │                           └─ ...
    │
    ├── ai.rs                  # Нейронная сеть
    │                           ├─ NeuralNetwork
    │                           ├─ forward()
    │                           └─ get_inputs()
    │
    ├── genetics.rs            # Генетический алгоритм
    │                           ├─ Population
    │                           ├─ evolve()
    │                           ├─ crossover()
    │                           ├─ mutate()
    │                           └─ selection()
    │
    ├── battle.rs              # Управление боями
    │                           ├─ BattleState
    │                           ├─ start_battle()
    │                           ├─ end_battle()
    │                           └─ spawn_tank()
    │
    ├── map.rs                 # Генерация карт
    │                           ├─ GameMap
    │                           ├─ new()
    │                           └─ spawn()
    │
    ├── camera.rs              # Управление камерой
    │                           ├─ CameraState
    │                           ├─ camera_control_system
    │                           └─ tank_selection_system
    │
    └── ui.rs                  # Пользовательский интерфейс
                                ├─ ui_system
                                ├─ setup_ui
                                └─ update_stats_ui
```

## Жизненный цикл танка

```
┌─────────────────┐
│  spawn_tank()   │
└────────┬────────┘
         │
    ┌────▼─────────────────────┐
    │  Entity + Components:    │
    │  - Tank                  │
    │  - AIController          │
    │  - Transform             │
    │  - PbrBundle (3D модель) │
    └────────┬─────────────────┘
             │
    ┌────────▼───────────┐
    │  Каждый кадр:      │
    │  ai_control_system │
    │  ├─ Анализ ситуации│
    │  ├─ Нейросеть      │
    │  └─ Действия       │
    └────────┬───────────┘
             │
    ┌────────▼───────────┐
    │  При попадании:    │
    │  collision_system  │
    │  health -= damage  │
    └────────┬───────────┘
             │
       ┌─────┴─────┐
       │           │
  ┌────▼────┐ ┌───▼──────┐
  │health>0 │ │health<=0 │
  └────┬────┘ └───┬──────┘
       │          │
       │     ┌────▼────────┐
       │     │ despawn()   │
       │     │ ai.kills++  │
       │     └─────────────┘
       │
  ┌────▼─────────────┐
  │ Конец боя:       │
  │ fitness =        │
  │ kills*100 +      │
  │ survival_time*2  │
  └──────────────────┘
```

## Модули взаимодействия

```
┌──────────┐
│  BATTLE  │
└─────┬────┘
      │ создает танков
      ▼
┌──────────┐         читает геномы
│GENETICS  │◄───────────────────────┐
└─────┬────┘                        │
      │ эволюционирует              │
      ▼                              │
┌──────────┐         использует     │
│    AI    │─────────────────────►┌─┴────┐
└──────────┘                       │TANKS │
                                   └─┬────┘
                    управляет        │
┌──────────┐◄─────────────────────┬─┘
│ SYSTEMS  │                      │
└─────┬────┘    обновляет         │
      │         позиции            │
      └────────────────────────────┘
```

## Параллелизм систем

Bevy автоматически распараллеливает системы:

```
Параллельно:
├─ ai_control_system       (не конфликтует)
├─ projectile_movement     (не конфликтует)
└─ camera_control_system   (не конфликтует)

Последовательно:
├─ collision_system        (изменяет Tank.health)
└─ health_display_system   (читает Tank.health)
```

## Оптимизации

1. **Spatial Hashing** (будущее): для ускорения поиска ближайших танков
2. **LOD** (Level of Detail): упрощение моделей на расстоянии
3. **Frustum Culling**: не рендерим невидимое
4. **Batch Processing**: обработка танков пакетами
5. **Parallel Evaluation**: параллельная оценка нейросетей

---

**Документ обновлен**: 2026-01-08
